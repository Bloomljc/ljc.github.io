<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—…è¡Œè§„åˆ’ Pro - æé€Ÿç‰ˆ</title>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root {
            --ios-bg: #f2f2f7;
            --ios-card: rgba(255, 255, 255, 0.9);
            --primary: #007aff;
            --accent: #5856d6;
            --food: #ff3b30;
            --spot: #ff9500;
            --shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: -apple-system, "PingFang SC", sans-serif;
            background: #f2f2f7; overflow: hidden;
        }

        #map { height: 100%; width: 100%; z-index: 1; background: #e5e5ea; }

        /* é¡¶éƒ¨æœç´¢æ ä¼˜åŒ– */
        .top-bar {
            position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000;
            display: flex; gap: 8px;
        }

        .glass-btn {
            background: var(--ios-card); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 14px; height: 50px; min-width: 50px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.4);
            font-size: 22px; cursor: pointer; transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .glass-btn:active { transform: scale(0.9); background: #e5e5ea; }

        .search-form {
            flex: 1; display: flex; background: var(--ios-card); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); border-radius: 14px;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.4);
            overflow: hidden;
        }
        .search-form input {
            flex: 1; border: none; background: transparent; padding: 0 15px;
            font-size: 16px; outline: none; height: 50px; color: #000;
        }

        /* ä¾§æ»‘æŠ½å±‰æ ·å¼ä¿æŒ */
        .drawer {
            position: fixed; top: 0; left: -90%; width: 85%; height: 100%;
            background: var(--ios-bg); z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
            box-shadow: 15px 0 50px rgba(0,0,0,0.2);
            border-top-right-radius: 20px; border-bottom-right-radius: 20px;
        }
        .drawer.active { transform: translateX(105.8%); }
        .drawer-header { padding: 50px 20px 20px; background: white; border-bottom: 0.5px solid #d1d1d6; }
        .drawer-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }

        /* å¡ç‰‡è®¾è®¡ */
        .section-card { background: white; border-radius: 16px; padding: 18px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .section-title { font-weight: bold; color: #8e8e93; font-size: 12px; text-transform: uppercase; margin-bottom: 12px; border-left: 3px solid var(--primary); padding-left: 8px;}

        input, select, textarea { width: 100%; padding: 14px; margin-top: 8px; border: none; border-radius: 10px; background: #f2f2f7; font-size: 16px; box-sizing: border-box; outline: none; }
        .primary-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 14px; font-weight: 600; font-size: 17px; margin-top: 15px; }
        
        /* äº¤é€šçº¿ */
        .itinerary-item { background: white; border-radius: 14px; padding: 15px; position: relative; border: 1px solid #efeff4; }
        .transport-bridge { margin: 0 0 0 35px; padding: 10px 15px; border-left: 2px dashed #c6c6c8; display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--primary); }
        
        .img-preview { width: 100%; height: 180px; background: #f2f2f7; border-radius: 12px; margin-top: 10px; border: 2px dashed #d1d1d6; display: flex; align-items: center; justify-content: center; background-size: cover; background-position: center; color: #8e8e93; font-size: 14px;}
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1500; display: none; backdrop-filter: blur(4px); }
        .overlay.active { display: block; }

        .day-header { font-size: 18px; font-weight: 800; margin: 20px 0 10px 0; color: #000; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="glass-btn" onclick="toggleDrawer()" id="menuBtn">â˜°</div>
    <form class="search-form" onsubmit="event.preventDefault(); jumpCity();">
        <input type="text" id="cityInput" placeholder="è¾“å…¥åŸå¸‚åï¼Œå¦‚å¤§ç†" enterkeyhint="search">
        <div class="glass-btn" style="box-shadow:none; border:none; height:50px; border-radius:0" onclick="jumpCity()" id="searchBtn">ğŸ”</div>
    </form>
</div>

<div class="drawer" id="drawer">
    <div class="drawer-header">
        <h2>æ—…è¡Œè®¡åˆ’ Pro</h2>
        <div id="loc-status" style="font-size:13px; color:var(--primary); margin-top:5px;">ğŸ“ åœ°å›¾é€‰ç‚¹æ¨¡å¼å·²å°±ç»ª</div>
    </div>
    <div class="drawer-content">
        <div class="section-card">
            <div class="section-title">âœ¨ æ–°å¢è¶³è¿¹</div>
            <input type="text" id="in-name" placeholder="åœ°ç‚¹åç§°">
            <div style="display:flex; gap:10px;">
                <select id="in-day" style="flex:1"><option>Day 1</option><option>Day 2</option><option>Day 3</option><option>Day 4</option></select>
                <input type="time" id="in-time" style="flex:1">
            </div>
            <select id="in-type">
                <option value="spot">ğŸï¸ æ™¯ç‚¹</option>
                <option value="food">ğŸ± ç¾é£Ÿ</option>
            </select>
            <div class="img-preview" id="img-pre" onclick="document.getElementById('file-in').click()">ç‚¹å‡»ä¸Šä¼ å®æ‹å›¾</div>
            <input type="file" id="file-in" hidden accept="image/*" onchange="previewImg(this)">
            <div style="background:#f2f2f7; border-radius:12px; padding:12px; margin-top:15px;">
                <label style="font-size:11px; color:#8e8e93;">äº¤é€šæ–¹å¼ï¼ˆå‰å¾€ä¸‹ä¸€ç«™ï¼‰ï¼š</label>
                <div style="display:flex; gap:8px;">
                    <select id="in-trans" style="flex:1"><option value="">æ— </option><option>ğŸš— æ‰“è½¦</option><option>ğŸš‡ å…¬äº¤</option><option>ğŸš¶ æ­¥è¡Œ</option></select>
                    <input type="text" id="in-trans-info" placeholder="è€—æ—¶" style="flex:1">
                </div>
            </div>
            <button class="primary-btn" onclick="saveData()">ä¿å­˜è‡³è¡Œç¨‹å•</button>
        </div>
        <div id="itinerary-box"></div>
        <div class="section-card" style="margin-top:20px;">
            <button class="primary-btn" style="background:#34c759;" onclick="exportData()">å¯¼å‡ºå¤‡ä»½</button>
            <button class="primary-btn" style="background:#8e8e93;" onclick="document.getElementById('imp-file').click()">å¯¼å…¥æ¢å¤</button>
            <input type="file" id="imp-file" hidden onchange="importData(this)">
            <button class="primary-btn" style="background:#ff3b30; margin-top:30px;" onclick="clearAll()">æ¸…ç©ºå…¨éƒ¨</button>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleDrawer()"></div>
<div id="map"></div>

<script>
    // å¸¸ç”¨åŸå¸‚å›½å†…åæ ‡åº“ï¼ˆç§’è·³è½¬ï¼‰
    const QUICK_CITIES = {
        "åŒ—äº¬": [39.9042, 116.4074], "ä¸Šæµ·": [31.2304, 121.4737], "å¹¿å·": [23.1291, 113.2644],
        "æ·±åœ³": [22.5431, 114.0579], "æˆéƒ½": [30.5728, 104.0668], "æ­å·": [30.2741, 120.1551],
        "è¥¿å®‰": [34.3416, 108.9398], "å—äº¬": [32.0603, 118.7969], "é‡åº†": [29.5630, 106.5516],
        "å¤§ç†": [25.5927, 100.2224], "ä¸½æ±Ÿ": [26.8721, 100.2297], "é’å²›": [36.0671, 120.3826],
        "å¦é—¨": [24.4798, 118.0894], "é•¿æ²™": [28.2282, 112.9388], "æ­¦æ±‰": [30.5928, 114.3055],
        "æ˜†æ˜": [25.0406, 102.7122], "ä¸‰äºš": [18.2525, 109.5121], "æ‹‰è¨": [29.6469, 91.1172]
    };

    let travelDB = JSON.parse(localStorage.getItem('TripPro_Data_v4')) || [];
    let curLat = null, curLng = null, curImg64 = "";

    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([30.27, 120.15], 12);
    L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
        subdomains: ["1", "2", "3", "4"]
    }).addTo(map);

    map.on('click', e => {
        curLat = e.latlng.lat; curLng = e.latlng.lng;
        document.getElementById('loc-status').innerText = `âœ… ä½ç½®å·²é€‰å®š: ${curLat.toFixed(3)}, ${curLng.toFixed(3)}`;
        setTimeout(toggleDrawer, 300);
    });

    function toggleDrawer() {
        document.getElementById('drawer').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
        if(document.getElementById('drawer').classList.contains('active')) renderList();
    }

    // ä¼˜åŒ–åçš„è·³è½¬é€»è¾‘
    async function jumpCity() {
        const input = document.getElementById('cityInput');
        const btn = document.getElementById('searchBtn');
        const city = input.value.trim();
        if(!city) return;

        // 1. ä¼˜å…ˆæ£€æŸ¥å†…ç½®åº“ (ç¬é—´å“åº”)
        if(QUICK_CITIES[city]) {
            map.flyTo(QUICK_CITIES[city], 12, { duration: 1.5 });
            input.blur();
            return;
        }

        // 2. è”ç½‘æœç´¢åé¦ˆ
        const originalBtn = btn.innerHTML;
        btn.innerHTML = "â³";
        btn.style.pointerEvents = "none";

        try {
            const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`, {
                headers: { 'Accept-Language': 'zh-CN,zh;q=0.9' }
            });
            const data = await resp.json();
            if(data && data.length > 0) {
                map.flyTo([data[0].lat, data[0].lon], 12, { duration: 1.5 });
                input.blur();
            } else {
                alert("æœªæ‰¾åˆ°è¯¥åŸå¸‚ï¼Œè¯·å°è¯•æ›´å‡†ç¡®çš„åç§°");
            }
        } catch (e) {
            alert("ç½‘ç»œæœç´¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç§»åŠ¨åœ°å›¾æˆ–æ£€æŸ¥ç½‘ç»œ");
        } finally {
            btn.innerHTML = originalBtn;
            btn.style.pointerEvents = "auto";
        }
    }

    function previewImg(input) {
        const reader = new FileReader();
        reader.onload = e => {
            curImg64 = e.target.result;
            const pre = document.getElementById('img-pre');
            pre.style.backgroundImage = `url(${curImg64})`;
            pre.innerText = "";
        };
        reader.readAsDataURL(input.files[0]);
    }

    function saveData() {
        const name = document.getElementById('in-name').value;
        if(!name || !curLat) return alert("è¯·å…ˆåœ¨åœ°å›¾é€‰ç‚¹å¹¶è¾“å…¥åœ°ç‚¹åç§°");
        const obj = {
            id: Date.now(), name, day: document.getElementById('in-day').value,
            time: document.getElementById('in-time').value, type: document.getElementById('in-type').value,
            img: curImg64, lat: curLat, lng: curLng,
            trans: document.getElementById('in-trans').value, transInfo: document.getElementById('in-trans-info').value
        };
        travelDB.push(obj);
        localStorage.setItem('TripPro_Data_v4', JSON.stringify(travelDB));
        renderMarkers();
        resetForm();
        toggleDrawer();
    }

    function resetForm() {
        document.getElementById('in-name').value = "";
        curImg64 = "";
        document.getElementById('img-pre').style.backgroundImage = "";
        document.getElementById('img-pre').innerText = "ç‚¹å‡»ä¸Šä¼ å®æ‹å›¾";
    }

    function renderList() {
        const box = document.getElementById('itinerary-box');
        box.innerHTML = "";
        const days = [...new Set(travelDB.map(i => i.day))].sort();
        days.forEach(day => {
            box.innerHTML += `<div class="day-header">${day}</div>`;
            travelDB.filter(i => i.day === day).sort((a,b)=>a.time.localeCompare(b.time)).forEach(item => {
                box.innerHTML += `
                    <div class="itinerary-item">
                        <span style="float:right;color:#ccc" onclick="deleteItem(${item.id})">âœ•</span>
                        <b>${item.time} ${item.name}</b>
                        ${item.img ? `<img src="${item.img}" style="width:100%;height:100px;object-fit:cover;border-radius:10px;margin-top:10px">`:''}
                    </div>
                `;
                if(item.trans) box.innerHTML += `<div class="transport-bridge">${item.trans} ${item.transInfo}</div>`;
            });
        });
    }

    function renderMarkers() {
        map.eachLayer(l => { if(l instanceof L.CircleMarker) map.removeLayer(l); });
        travelDB.forEach(p => {
            const m = L.circleMarker([p.lat, p.lng], {
                radius: 12, color: '#fff', weight: 3, fillOpacity: 1, fillColor: p.type==='food'?'#ff3b30':'#ff9500'
            }).addTo(map);
            m.bindPopup(`<div style="width:180px"><b>${p.name}</b><br><small>${p.day} ${p.time}</small>${p.img?`<img src="${p.img}" style="width:100%;margin-top:5px;border-radius:5px">`:''}</div>`);
        });
    }

    function deleteItem(id) {
        if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
            travelDB = travelDB.filter(i => i.id !== id);
            localStorage.setItem('TripPro_Data_v4', JSON.stringify(travelDB));
            renderList(); renderMarkers();
        }
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(travelDB)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Trip_Backup.json`;
        a.click();
    }

    function importData(input) {
        const reader = new FileReader();
        reader.onload = e => {
            travelDB = JSON.parse(e.target.result);
            localStorage.setItem('TripPro_Data_v4', JSON.stringify(travelDB));
            renderMarkers(); alert("å¯¼å…¥æˆåŠŸï¼");
        };
        reader.readAsText(input.files[0]);
    }

    function clearAll() { if(confirm("æ¸…ç©ºå…¨éƒ¨ï¼Ÿ")) { travelDB=[]; localStorage.clear(); location.reload(); } }

    renderMarkers();
</script>
</body>
</html>