<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ—…è¡Œè§„åˆ’ Pro</title>
    <!-- å›½å†…åŠ é€Ÿèµ„æº -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <style>
        :root {
            --ios-bg: #f2f2f7;
            --ios-card: rgba(255, 255, 255, 0.85);
            --primary: #007aff;
            --accent: #5856d6;
            --food: #ff3b30;
            --spot: #ff9500;
            --shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            font-family: -apple-system, "PingFang SC", sans-serif;
            background: #000; overflow: hidden;
        }

        /* åœ°å›¾åº•å±‚ */
        #map { height: 100%; width: 100%; z-index: 1; }

        /* é¡¶éƒ¨æ‚¬æµ®æ  */
        .top-bar {
            position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000;
            display: flex; gap: 10px;
        }

        .glass-btn {
            background: var(--ios-card);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 14px;
            height: 50px; width: 50px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.3);
            font-size: 22px; cursor: pointer;
        }

        .search-bar {
            flex: 1; background: var(--ios-card); backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px); border-radius: 14px;
            display: flex; align-items: center; padding: 0 15px;
            box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.3);
        }
        .search-bar input {
            border: none; background: transparent; width: 100%; height: 100%;
            font-size: 16px; outline: none;
        }

        /* ä¾§è¾¹æŠ½å±‰ */
        .drawer {
            position: fixed; top: 0; left: -90%; width: 85%; height: 100%;
            background: var(--ios-bg); z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
            box-shadow: 15px 0 50px rgba(0,0,0,0.2);
            border-top-right-radius: 20px; border-bottom-right-radius: 20px;
        }
        .drawer.active { transform: translateX(105.8%); }

        .drawer-header {
            padding: 50px 20px 20px; background: white;
            border-bottom: 0.5px solid #d1d1d6;
        }
        .drawer-header h2 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; }

        .drawer-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 50px; }

        /* å†…å®¹æ¿å—å¡ç‰‡ */
        .section-card {
            background: white; border-radius: 16px; padding: 18px;
            margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .section-title { font-weight: bold; color: #8e8e93; font-size: 13px; text-transform: uppercase; margin-bottom: 12px; display: flex; align-items: center; gap: 5px;}

        /* è¾“å…¥æ ·å¼ */
        input, select, textarea {
            width: 100%; padding: 14px; margin-top: 8px; border: none;
            border-radius: 10px; background: #f2f2f7; font-size: 16px;
            box-sizing: border-box; outline: none; color: #000;
        }
        .primary-btn {
            background: var(--primary); color: white; border: none; width: 100%;
            padding: 16px; border-radius: 14px; font-weight: 600; font-size: 17px;
            margin-top: 15px; transition: 0.2s;
        }
        .primary-btn:active { transform: scale(0.98); opacity: 0.9; }

        /* è¡Œç¨‹å•ä¸²è”è®¾è®¡ */
        .itinerary-container { padding: 5px 0; }
        .itinerary-item {
            background: white; border-radius: 14px; padding: 15px;
            position: relative; border: 1px solid #efeff4;
        }
        .itinerary-item b { display: block; margin-bottom: 4px; font-size: 17px; }
        .itinerary-item span { font-size: 13px; color: #8e8e93; }

        /* äº¤é€šä¸²è”æ¡¥ */
        .transport-bridge {
            margin: 0 0 0 35px; padding: 10px 15px;
            border-left: 2px dashed #c6c6c8; display: flex; align-items: center;
            gap: 10px; font-size: 13px; color: var(--primary); font-weight: 500;
        }
        .transport-bridge i { background: #f2f2f7; border-radius: 6px; padding: 2px 6px; }

        /* å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ */
        .img-preview {
            width: 100%; height: 180px; background: #f2f2f7; border-radius: 12px;
            margin-top: 10px; border: 2px dashed #d1d1d6; display: flex;
            align-items: center; justify-content: center; overflow: hidden;
            background-size: cover; background-position: center; color: #8e8e93;
        }

        /* é®ç½© */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 1500; display: none;
            backdrop-filter: blur(4px);
        }
        .overlay.active { display: block; }

        /* åœ°å›¾æ°”æ³¡å®šåˆ¶ */
        .leaflet-popup-content-wrapper { border-radius: 15px; padding: 0; overflow: hidden; }
        .popup-img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .popup-info { padding: 12px; }

        /* æ—¥æœŸæ ‡ç­¾ */
        .day-header {
            font-size: 20px; font-weight: 800; margin: 25px 0 15px 0;
            color: #000; display: flex; align-items: center; gap: 10px;
        }
        .day-header::after { content: ""; flex: 1; height: 1px; background: #e5e5ea; }

    </style>
</head>
<body>

<!-- é¡¶éƒ¨äº¤äº’å±‚ -->
<div class="top-bar">
    <div class="glass-btn" onclick="toggleDrawer()">â˜°</div>
    <div class="search-bar">
        <input type="text" id="cityInput" placeholder="æƒ³å»å“ªä¸ªåŸå¸‚ï¼Ÿ" onkeydown="if(event.key==='Enter') jumpCity()">
    </div>
    <div class="glass-btn" onclick="jumpCity()">ğŸ”</div>
</div>

<!-- ä¾§æ»‘æŠ½å±‰ -->
<div class="drawer" id="drawer">
    <div class="drawer-header">
        <h2>æˆ‘çš„æ—…è¡Œè®¡åˆ’</h2>
        <div id="loc-status" style="font-size:13px; color:var(--primary); margin-top:5px;">ğŸ“ åœ¨åœ°å›¾ä¸Šç‚¹å‡»å³å¯é€‰ç‚¹</div>
    </div>
    
    <div class="drawer-content">
        <!-- æ·»åŠ æ¨¡å— -->
        <div class="section-card">
            <div class="section-title">âœ¨ æ·»åŠ è¶³è¿¹</div>
            <input type="text" id="in-name" placeholder="åœ°ç‚¹åç§°">
            <div style="display:flex; gap:10px;">
                <select id="in-day" style="flex:1"><option>Day 1</option><option>Day 2</option><option>Day 3</option><option>Day 4</option></select>
                <input type="time" id="in-time" style="flex:1.2">
            </div>
            <select id="in-type">
                <option value="spot">ğŸï¸ æ™¯ç‚¹é¡¹ç›®</option>
                <option value="food">ğŸ± å¿…åƒç¾é£Ÿ</option>
            </select>
            
            <div class="img-preview" id="img-pre" onclick="document.getElementById('file-in').click()">
                <span>ç‚¹å‡»ä¸Šä¼ å®æ‹å›¾</span>
            </div>
            <input type="file" id="file-in" hidden accept="image/*" onchange="previewImg(this)">

            <!-- åµŒå…¥å¼äº¤é€š -->
            <div style="background:#f2f2f7; border-radius:12px; padding:12px; margin-top:15px;">
                <label style="font-size:12px; color:#8e8e93; font-weight:600;">ğŸš¦ å‰å¾€ä¸‹ä¸€ç«™äº¤é€šï¼š</label>
                <div style="display:flex; gap:8px; margin-top:5px;">
                    <select id="in-trans" style="margin:0; flex:1"><option value="">æ— äº¤é€š</option><option>ğŸš— æ‰“è½¦/é©¾è½¦</option><option>ğŸš‡ åœ°é“/å…¬äº¤</option><option>ğŸš¶ æ­¥è¡Œ</option></select>
                    <input type="text" id="in-trans-info" placeholder="è€—æ—¶/è·¯çº¿" style="margin:0; flex:1">
                </div>
            </div>

            <button class="primary-btn" onclick="saveData()">å­˜å…¥æ”»ç•¥å•</button>
        </div>

        <!-- è¡Œç¨‹å• -->
        <div class="itinerary-container" id="itinerary-box">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
        </div>

        <!-- å·¥å…· -->
        <div class="section-card" style="margin-top:20px;">
            <div class="section-title">âš™ï¸ æ•°æ®ç®¡ç†</div>
            <button class="primary-btn" style="background:#34c759; margin-top:0;" onclick="exportData()">å¯¼å‡º JSON å¤‡ä»½</button>
            <button class="primary-btn" style="background:#8e8e93;" onclick="document.getElementById('imp-file').click()">å¯¼å…¥æ”»ç•¥æ¢å¤</button>
            <input type="file" id="imp-file" hidden onchange="importData(this)">
            <button class="primary-btn" style="background:#ff3b30; margin-top:40px;" onclick="clearAll()">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
        </div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleDrawer()"></div>
<div id="map"></div>

<script>
    let travelDB = JSON.parse(localStorage.getItem('TripPro_Data_v3')) || [];
    let curLat = null, curLng = null, curImg64 = "";

    // 1. åœ°å›¾åˆå§‹åŒ– (é«˜å¾·åº•å›¾)
    const map = L.map('map', { zoomControl: false }).setView([30.27, 120.15], 12);
    L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
        subdomains: ["1", "2", "3", "4"],
        attribution: 'Â© é«˜å¾·åœ°å›¾'
    }).addTo(map);

    map.on('click', e => {
        curLat = e.latlng.lat; curLng = e.latlng.lng;
        document.getElementById('loc-status').innerText = `âœ… é€‰å®šï¼š${curLat.toFixed(3)}, ${curLng.toFixed(3)}`;
        setTimeout(toggleDrawer, 300);
    });

    function toggleDrawer() {
        document.getElementById('drawer').classList.toggle('active');
        document.getElementById('overlay').classList.toggle('active');
        if(document.getElementById('drawer').classList.contains('active')) renderList();
    }

    // 2. åŸå¸‚è·³è½¬
    function jumpCity() {
        const city = document.getElementById('cityInput').value;
        if(!city) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`)
            .then(r => r.json()).then(data => {
                if(data[0]) {
                    map.flyTo([data[0].lat, data[0].lon], 12);
                    document.getElementById('cityInput').blur();
                }
            });
    }

    // 3. å›¾ç‰‡é¢„è§ˆ
    function previewImg(input) {
        const reader = new FileReader();
        reader.onload = e => {
            curImg64 = e.target.result;
            const pre = document.getElementById('img-pre');
            pre.style.backgroundImage = `url(${curImg64})`;
            pre.innerHTML = "";
        };
        reader.readAsDataURL(input.files[0]);
    }

    // 4. æ•°æ®æ“ä½œ
    function saveData() {
        const name = document.getElementById('in-name').value;
        if(!name || !curLat) return alert("è¯·åœ¨åœ°å›¾é€‰ç‚¹å¹¶è¾“å…¥åç§°");

        const obj = {
            id: Date.now(),
            name: name,
            day: document.getElementById('in-day').value,
            time: document.getElementById('in-time').value,
            type: document.getElementById('in-type').value,
            img: curImg64,
            lat: curLat, lng: curLng,
            trans: document.getElementById('in-trans').value,
            transInfo: document.getElementById('in-trans-info').value
        };

        travelDB.push(obj);
        localStorage.setItem('TripPro_Data_v3', JSON.stringify(travelDB));
        renderMarkers();
        resetForm();
        toggleDrawer();
    }

    function resetForm() {
        document.getElementById('in-name').value = "";
        curImg64 = "";
        document.getElementById('img-pre').style.backgroundImage = "";
        document.getElementById('img-pre').innerHTML = "<span>ç‚¹å‡»ä¸Šä¼ å®æ‹å›¾</span>";
        document.getElementById('loc-status').innerText = "ğŸ“ é€‰ç‚¹æˆåŠŸï¼Œè¯·å¡«å†™ä¿¡æ¯";
    }

    // 5. æ¸²æŸ“è¡Œç¨‹ (é‡ç‚¹ä¼˜åŒ–äº¤é€šè¿æ¥)
    function renderList() {
        const box = document.getElementById('itinerary-box');
        box.innerHTML = "";
        const days = [...new Set(travelDB.map(i => i.day))].sort();

        days.forEach(day => {
            box.innerHTML += `<div class="day-header">ğŸ—“ï¸ ${day}</div>`;
            const dayItems = travelDB.filter(i => i.day === day).sort((a,b)=>a.time.localeCompare(b.time));
            
            dayItems.forEach((item, index) => {
                box.innerHTML += `
                    <div class="itinerary-item">
                        <span style="float:right; color:#ccc;" onclick="deleteItem(${item.id})">âœ•</span>
                        <b>${item.time} ${item.name}</b>
                        <span>${item.type === 'food' ? 'ğŸ± ç¾é£Ÿé¤å…' : 'ğŸï¸ æ™¯ç‚¹åœ°æ ‡'}</span>
                        ${item.img ? `<img src="${item.img}" style="width:100%; height:80px; object-fit:cover; border-radius:8px; margin-top:10px;">` : ''}
                    </div>
                `;
                // å¦‚æœè®¾ç½®äº†äº¤é€šï¼Œä¸”ä¸æ˜¯æœ€åä¸€ä¸ªï¼Œæ¸²æŸ“è¿æ¥æ¡¥
                if (item.trans) {
                    box.innerHTML += `
                        <div class="transport-bridge">
                            <i>${item.trans.split(' ')[0]}</i>
                            <span>${item.transInfo || 'æŒç»­å‡ºå‘'}</span>
                        </div>
                    `;
                }
            });
        });
    }

    // 6. æ¸²æŸ“åœ°å›¾ç‚¹
    function renderMarkers() {
        map.eachLayer(l => { if(l instanceof L.CircleMarker) map.removeLayer(l); });
        travelDB.forEach(p => {
            const color = p.type === 'food' ? '#ff3b30' : '#ff9500';
            const m = L.circleMarker([p.lat, p.lng], {
                radius: 12, color: '#fff', weight: 3, fillOpacity: 1, fillColor: color
            }).addTo(map);
            
            const popup = `
                <div style="width:200px">
                    ${p.img ? `<img src="${p.img}" class="popup-img">` : ''}
                    <div class="popup-info">
                        <strong style="font-size:16px">${p.name}</strong><br>
                        <small style="color:#8e8e93">${p.day} Â· ${p.time}</small>
                        ${p.trans ? `<div style="font-size:12px; color:#007aff; margin-top:5px;">ğŸš¦ ä¸‹ä¸€ç«™ï¼š${p.trans}</div>` : ''}
                    </div>
                </div>
            `;
            m.bindPopup(popup, { padding: [0,0] });
        });
    }

    function deleteItem(id) {
        if(confirm("ç¡®å®šåˆ é™¤æ­¤é¡¹è¡Œç¨‹ï¼Ÿ")) {
            travelDB = travelDB.filter(i => i.id !== id);
            localStorage.setItem('TripPro_Data_v3', JSON.stringify(travelDB));
            renderList();
            renderMarkers();
        }
    }

    function exportData() {
        const blob = new Blob([JSON.stringify(travelDB)], {type: "application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `æˆ‘çš„æ—…è¡Œè®¡åˆ’_${new Date().getMonth()+1}æœˆ.json`;
        a.click();
    }

    function importData(input) {
        const reader = new FileReader();
        reader.onload = e => {
            travelDB = JSON.parse(e.target.result);
            localStorage.setItem('TripPro_Data_v3', JSON.stringify(travelDB));
            renderMarkers();
            alert("å¯¼å…¥æ¢å¤æˆåŠŸï¼");
        };
        reader.readAsText(input.files[0]);
    }

    function clearAll() {
        if(confirm("å±é™©æ“ä½œï¼šå°†æ¸…ç©ºæ‰€æœ‰å·²ä¿å­˜çš„æ—…è¡Œæ”»ç•¥ï¼")) {
            travelDB = [];
            localStorage.clear();
            location.reload();
        }
    }

    renderMarkers();
</script>

</body>
</html>